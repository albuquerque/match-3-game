name: Multi-Platform Build (Godot)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  GODOT_VERSION: 4.5
  EXPORT_NAME: match3-game

jobs:
  build:
    strategy:
      matrix:
        platform: [linux, macos]
        include:
          - platform: linux
            runner: ubuntu-latest
            preset: "Linux/X11"
            filename: "match3-game.x86_64"
            path: "build/linux/"
          - platform: macos
            runner: macos-latest
            preset: "macOS"
            filename: "match3-game.zip"
            path: "build/mac/"

    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Godot Assets
        id: cache-godot
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/godot/export_templates
            ~/godot
          key: godot-${{ env.GODOT_VERSION }}-${{ matrix.platform }}

      - name: Download Godot Headless + Export Templates (if needed)
        if: steps.cache-godot.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          RELEASE_BASE="https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable"
          
          if [[ "${{ matrix.platform }}" == "linux" ]]; then
            HEADLESS_FILE="Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip"
          else
            HEADLESS_FILE="Godot_v${GODOT_VERSION}-stable_macos.universal.zip"
          fi
          
          TEMPLATES_FILE="Godot_v${GODOT_VERSION}-stable_export_templates.tpz"
          
          download() {
            local file="$1" url="${RELEASE_BASE}/$1"
            echo "Downloading $file from $url"
            curl -fSL --connect-timeout 20 --retry 6 --retry-delay 5 --retry-all-errors -o "$file" "$url"
          }
          
          download "$HEADLESS_FILE"
          unzip -q "$HEADLESS_FILE" -d ~/godot_raw
          
          if [[ "${{ matrix.platform }}" == "linux" ]]; then
            mv ~/godot_raw/Godot_v${GODOT_VERSION}-stable_linux.x86_64 ~/godot
          else
            mv ~/godot_raw/Godot.app/Contents/MacOS/Godot ~/godot
          fi
          
          chmod +x ~/godot
          echo "Godot headless installed at ~/godot"
          
          download "$TEMPLATES_FILE"
          mkdir -p ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
          unzip -q "$TEMPLATES_FILE" -d /tmp/templates_extracted
          mv /tmp/templates_extracted/templates/* ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable/
          echo "Templates installed: $(ls ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable | wc -l) files"

      - name: Verify Godot & Templates
        run: |
          set -e
          ~/godot --version
          echo "Listing templates:"; ls -1 ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable | head -20

      - name: Export ${{ matrix.platform }} Build
        run: |
          set -e
          echo "üî® Building ${{ matrix.platform }} version..."
          mkdir -p ${{ matrix.path }}
          ~/godot --headless --export-release "${{ matrix.preset }}" "${{ matrix.path }}${{ matrix.filename }}"
          
          if [ $? -eq 0 ]; then
            echo "üéâ SUCCESS! ${{ matrix.platform }} build completed!"
            ls -lh ${{ matrix.path }}
          else
            echo "‚ùå ${{ matrix.platform }} build failed"
            exit 1
          fi

      - name: Upload ${{ matrix.platform }} Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: ${{ matrix.path }}${{ matrix.filename }}

  release:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.GODOT_VERSION }}-${{ github.run_number }}
          name: Multi-Platform Build ${{ env.GODOT_VERSION }} (Run ${{ github.run_number }})
          body: |
            Automated multi-platform export generated by CI.
            
            **Platforms included:**
            - üêß Linux (x86_64)
            - üçé macOS (Universal)
            
            **Build info:**
            - Godot Version: ${{ env.GODOT_VERSION }}
            - Commit: ${{ github.sha }}
            - Build Number: ${{ github.run_number }}
          files: ./artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
