name: Multi-Platform Build (Godot)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  GODOT_VERSION: 4.3
  EXPORT_NAME: match3-game

jobs:
  build:
    name: Build All Platforms
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Setup
        run: |
          mkdir -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build for Windows
        run: |
          mkdir -p build/windows
          godot --headless --verbose --export-debug "Windows Desktop" build/windows/match3-game.exe

      - name: Build for Linux
        run: |
          mkdir -p build/linux
          godot --headless --verbose --export-debug "Linux/X11" build/linux/match3-game.x86_64

      - name: Build for macOS
        run: |
          mkdir -p build/mac
          godot --headless --verbose --export-debug "macOS" build/mac/match3-game.zip

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: build/windows/match3-game.exe

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: build/linux/match3-game.x86_64

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: build/mac/match3-game.zip

  release:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.GODOT_VERSION }}-${{ github.run_number }}
          name: Multi-Platform Build ${{ env.GODOT_VERSION }} (Run ${{ github.run_number }})
          body: |
            Automated multi-platform export generated by CI.
            
            **Platforms included:**
            - üêß Linux (x86_64)
            - üçé macOS (Universal)
            - ü™ü Windows (x64)
            
            **Build info:**
            - Godot Version: ${{ env.GODOT_VERSION }}
            - Commit: ${{ github.sha }}
            - Build Number: ${{ github.run_number }}
          files: ./artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
