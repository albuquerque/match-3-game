name: Android Build (Godot)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  GODOT_VERSION: 4.3
  EXPORT_NAME: match3-game

jobs:
  android-export:
    name: Android Export
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Godot Assets
        id: cache-godot
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/godot/export_templates
            ~/godot
          key: godot-${{ env.GODOT_VERSION }}

      - name: Download Godot Headless + Export Templates (if needed)
        if: steps.cache-godot.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          RELEASE_BASE="https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable"
          HEADLESS_FILE="Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip"
          TEMPLATES_FILE="Godot_v${GODOT_VERSION}-stable_export_templates.tpz"
          download() {
            local file="$1" url="${RELEASE_BASE}/$1"
            echo "Downloading $file from $url"
            curl -fSL --connect-timeout 20 --retry 6 --retry-delay 5 --retry-all-errors -o "$file" "$url"
          }
          download "$HEADLESS_FILE"
          unzip -q "$HEADLESS_FILE" -d ~/godot_raw
          mv ~/godot_raw/Godot_v${GODOT_VERSION}-stable_linux.x86_64 ~/godot
          chmod +x ~/godot
          echo "Godot headless installed at ~/godot"
          download "$TEMPLATES_FILE"
          mkdir -p ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
          unzip -q "$TEMPLATES_FILE" -d /tmp/templates_extracted
          mv /tmp/templates_extracted/templates/* ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable/
          echo "Templates installed: $(ls ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable | wc -l) files"

      - name: Verify Godot & Templates
        run: |
          set -e
          ~/godot --version
          echo "Listing templates:"; ls -1 ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable | head -20
          test -f ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable/android_release.apk || (echo "Android template missing" && exit 1)

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK (platform + build tools + NDK)
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: '9477386'
          accept-android-sdk-licenses: true
          packages: 'platforms;android-33 platform-tools build-tools;33.0.2 ndk;25.1.8937393'

      - name: Prepare Android Build Template
        run: |
          set -e
          echo "Ensuring clean android build template..."
          rm -rf android
          mkdir -p android
          ANDROID_SRC=$(find ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable -maxdepth 1 -name 'android_source.zip' | head -1)
          if [ -z "$ANDROID_SRC" ]; then
            echo "android_source.zip not found in export templates" && exit 1
          fi
          TMP_EXTRACT=$(mktemp -d)
          unzip -q "$ANDROID_SRC" -d "$TMP_EXTRACT"
          # Move contents (supports both direct files and nested android/ directory inside zip)
          if [ -d "$TMP_EXTRACT/android" ]; then
            shopt -s dotglob
            mv "$TMP_EXTRACT/android"/* android/
          else
            shopt -s dotglob
          # Ensure nested build/ directory (Godot expects android/build/build.gradle for custom template)
          if [ -f android/build/build.gradle ]; then
            echo "Nested build directory present."
          elif [ -f android/build.gradle ]; then
            echo "Wrapping root-level gradle project into build/ directory."
            mkdir -p android/build
            mv android/build.gradle android/settings.gradle android/gradle.properties android/build/ 2>/dev/null || true
            [ -d android/gradle ] && mv android/gradle android/build/
            [ -f android/gradlew ] && mv android/gradlew android/build/
            [ -f android/gradlew.bat ] && mv android/gradlew.bat android/build/
            for d in libs res src assetPacks assets ; do [ -d "android/$d" ] && mv "android/$d" android/build/; done
            echo "Wrapping root-level Gradle project into build/ directory for consistency"
            mkdir -p android/build
            # Move gradle-related files into build/
          echo "Final build.gradle at:"; ls -1 android/build/build.gradle
          rm -rf android/build/assets || true
            [ -f android/gradlew.bat ] && mv android/gradlew.bat android/build/
            # Move any libs/res/src if present
            for d in libs res src assetPacks; do [ -d "android/$d" ] && mv "android/$d" android/build/; done
          else
            echo "No build.gradle found after extraction" && find android -maxdepth 4 -name build.gradle && exit 1
          fi
          echo "Final build.gradle locations:"; find android -maxdepth 3 -type f -name build.gradle
          # Clean precompiled assets (Godot will generate fresh ones)
          rm -rf android/build/assets android/assets || true
          echo "Android template normalization complete."

      - name: Create Editor Settings
        run: |
          set -e
          SETTINGS_DIR=~/.config/godot
          mkdir -p "$SETTINGS_DIR"
          {
            echo '[gd_resource type="EditorSettings" format=3]'
            echo
            echo '[resource]'
            echo "export/android/android_sdk_path = \"${ANDROID_SDK_ROOT:-$ANDROID_HOME}\""
            echo "export/android/java_sdk_path = \"$JAVA_HOME\""
            echo 'export/android/debug_keystore = ""'
            echo 'export/android/force_system_user = false'
            echo 'export/android/shutdown_adb_on_exit = true'
            echo 'export/android/use_custom_build_tools_version = false'
            echo 'export/android/custom_build_tools_version = "33.0.2"'
          } > "$SETTINGS_DIR/editor_settings-4.tres"
          echo "Editor settings created:"; sed -n '1,25p' "$SETTINGS_DIR/editor_settings-4.tres"

      - name: Sanity Check Android Tooling
        run: |
          set -e
          echo "ANDROID_HOME=$ANDROID_HOME"; echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"; echo "JAVA_HOME=$JAVA_HOME"
          ls -1 $ANDROID_HOME/platform-tools | head -10 || true
          test -x $ANDROID_HOME/platform-tools/adb || (echo "adb missing" && exit 1)
          test -d $ANDROID_HOME/build-tools/33.0.2 || (echo "build tools 33.0.2 missing" && exit 1)
          ls -1 android/build | head -20

      - name: List Export Presets
        run: |
          echo "Export presets file:"; sed -n '1,120p' export_presets.cfg

      - name: Export Android APK
        run: |
          set -e
          mkdir -p build/android
          ~/godot --headless --verbose --export-release "Android" build/android/${EXPORT_NAME}.apk
          ls -lh build/android

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/android/*.apk

      - name: (Optional) Create Timestamped Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-v${{ env.GODOT_VERSION }}-${{ github.run_number }}
          name: Android Build ${{ env.GODOT_VERSION }} (Run ${{ github.run_number }})
          body: |
            Automated Android export generated by CI.
            Commit: ${{ github.sha }}
          files: build/android/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
